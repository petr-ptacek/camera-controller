var b=Object.defineProperty;var p=Object.getOwnPropertySymbols;var A=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var y=(o,c,r)=>c in o?b(o,c,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[c]=r,m=(o,c)=>{for(var r in c||(c={}))A.call(c,r)&&y(o,r,c[r]);if(p)for(var r of p(c))B.call(c,r)&&y(o,r,c[r]);return o};(function(o,c){typeof exports=="object"&&typeof module!="undefined"?module.exports=c():typeof define=="function"&&define.amd?define(c):(o=typeof globalThis!="undefined"?globalThis:o||self,o.CameraController=c())})(this,function(){"use strict";async function o(s){const e={data:null,error:null};try{e.data=await s}catch(t){e.error=t}return e}class c{constructor(e){var t,i;this._options=e,this._faceUndetectedTimeoutMs=(i=(t=this._options)==null?void 0:t.faceUndetectedTimeoutMs)!=null?i:2e4,this._modelsUrl=e.modelsUrl,this._tinyFaceDetectorOptions=null,this._videoInput=e.videoElement,this._canvas=this._createHelperCanvas(),this._faceDetectionIntervalId=null,this._faceUndetectedDatetime=null}async _detectSingleFace(){return await faceapi.detectSingleFace(this._videoInput,this._tinyFaceDetectorOptions)}_getVideoDisplaySize(){return{width:this._videoInput.width,height:this._videoInput.height}}_createHelperCanvas(){const e=faceapi.createCanvasFromMedia(this._videoInput);return e.style.position="absolute",faceapi.matchDimensions(e,this._getVideoDisplaySize()),document.body.append(e),e}async _drawDetections(e){this._canvas.getContext("2d").clearRect(0,0,this._canvas.width,this._canvas.height),faceapi.draw.drawDetections(this._canvas,faceapi.resizeResults(e,this._getVideoDisplaySize()))}async _loadModels(){const e=[];faceapi.nets.tinyFaceDetector.isLoaded||e.push(faceapi.nets.tinyFaceDetector.loadFromUri(this._modelsUrl)),await Promise.all(e)}_faceDetectedHandler(e){var t,i;this._faceUndetectedDatetime=null,(i=(t=this._options).onFaceDetected)==null||i.call(t)}_faceUndetectedHandler(){var e,t;this._faceUndetectedDatetime||(this._faceUndetectedDatetime=new Date),Date.now()-this._faceUndetectedDatetime.getTime()>this._faceUndetectedTimeoutMs&&((t=(e=this._options).onFaceUndetected)==null||t.call(e),this._faceUndetectedDatetime=null)}_startFaceDetection(){this._faceDetectionIntervalId=setInterval(async()=>{const e=await this._detectSingleFace();e?this._faceDetectedHandler(e):this._faceUndetectedHandler()},1e3)}_stopFaceDetection(){clearInterval(this._faceDetectionIntervalId),this._faceDetectionIntervalId=null}_destroyCanvas(){this._canvas.parentElement&&this._canvas.parentElement.removeChild(this._canvas),this._canvas=null}destroy(){this._stopFaceDetection(),this._destroyCanvas()}async init(){const{error:e}=await o(this._loadModels());if(e)throw new Error("Failed to load face-api models ...");this._tinyFaceDetectorOptions=new faceapi.TinyFaceDetectorOptions({scoreThreshold:.4}),this._startFaceDetection()}}function r(s,e){typeof e=="string"&&document.querySelector(e).append(s),e instanceof HTMLElement&&e.append(s)}function g(s,e={}){const[t,i]=s.split(","),a=e.mimeType||t.substring(t.indexOf(":")+1,t.indexOf(";")),n=atob(i),d=Array.from({length:n.length});for(let h=0,l=n.length;h<l;h++)d[h]=n.charCodeAt(h);return new Blob([new Uint8Array(d)],{type:a})}function w(s,e){return new File([s],e.fileName,{type:e.mimeType||s.type})}function D(s,e,t,i){let a=t,n=i;return i>t?a=i*s/e:n=e*t/s,{width:Math.round(a),height:Math.round(n)}}function E(s={}){const e=document.createElement("canvas"),t=e.getContext("2d");return typeof s.width=="number"&&(e.width=s.width),typeof s.height=="number"&&(e.height=s.height),typeof s.bgColor=="string"&&(t.fillStyle=s.bgColor,t.fillRect(0,0,e.width,e.height),t.fill()),e}async function _(s){return new Promise((e,t)=>{const i=new Image,a=()=>{delete i.onload,delete i.onerror};i.onload=()=>{a(),e(i)},i.onerror=n=>{a(),t(n)},i.src=s,i.complete&&(a(),e(i))})}function f(s={}){var t;const e=document.createElement("video");return e.muted=!0,e.autoplay=(t=s.autoplay)!=null?t:!0,typeof s.width=="number"&&typeof s.height=="number"&&(e.width=s.width,e.height=s.height),e}async function v(s,e){const t=document.createElement("canvas"),i=t.getContext("2d"),a=s instanceof HTMLImageElement?s:await _(s);return t.width=e.width,t.height=e.height,i.drawImage(a,0,0,e.width,e.height),await _(t.toDataURL(void 0,e.quality))}async function S(s,e={}){var d;let t=400,i=400;const a=s instanceof HTMLImageElement?s:await _(s);typeof e.width=="number"&&typeof e.height=="number"&&(t=e.width,i=e.height),typeof e.width=="number"&&typeof e.height!="number"&&(t=e.width,i=0),typeof e.height=="number"&&typeof e.width!="number"&&(i=e.height,t=0);const n=D(a.naturalWidth,a.naturalHeight,t,i);return await v(a,{quality:(d=e.quality)!=null?d:.85,width:n.width,height:n.height})}class u{constructor(e={}){var t,i,a,n,d,h,l;this._options=e,this._videoOptions=m({width:200,height:200},(t=e.videoOptions)!=null?t:{}),this._screenshotOptions=m({useAspectRatio:!0,quality:.85,width:(a=(i=this._videoOptions)==null?void 0:i.width)!=null?a:400,height:(d=(n=this._videoOptions)==null?void 0:n.height)!=null?d:400},(h=e.screenshotOptions)!=null?h:{}),this._faceDetectOptions=m({faceUndetectedTimeoutMs:2e4},(l=e.faceDetectOptions)!=null?l:{}),this._faceDetector=null,this._videoBaseElement=null,this._videoScreenElement=null,this._mediaStream=null,this._isActive=!1}isActive(){return this._isActive}static isAvailableCameraDevice(){return"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices}_createBaseVideoElement(){const e=f({autoplay:!1});return e.dataset.cssVisible="",e.dataset.cssHidden="position:fixed;top:0;left:0;z-index:-10000;opacity:0;",e.style.cssText=e.dataset.cssHidden,e}async _createMediaStream(){let e=null;try{e=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:960},audio:!1})}catch(t){this._createMediaStreamErrorHandler(t)}if(e){const[t]=e.getTracks().filter(i=>i.kind==="video");t.onended=i=>{var a,n;(n=(a=this._options).onRecordingInterrupted)==null||n.call(a),this.stop()}}return e}_createMediaStreamErrorHandler(e){var t,i,a,n;switch(e.name){case"NotAllowedError":(i=(t=this._options).onDevicePermissionDenied)==null||i.call(t),this.stop();break;case"NotFoundError":(n=(a=this._options).onDeviceNotAvailable)==null||n.call(a),this.stop();break;default:console.log(e)}}async _makeScreenshot(){if(!this._isActive)return null;const e=E({width:this._videoBaseElement.videoWidth,height:this._videoBaseElement.videoHeight}),t=e.getContext("2d");return t.fillRect(0,0,e.width,e.height),t.drawImage(this._videoBaseElement,0,0,e.width,e.height),e.toDataURL("image/png",1)}_destroy(){this._destroyVideoScreen(),this._destroyVideoBase(),this._destroyMediaStream(),this._destroyFaceDetector(),this._isActive=!1}_destroyVideoBase(){!this._videoBaseElement||(this._videoBaseElement.pause(),this._videoBaseElement.srcObject=null,this._videoBaseElement.parentElement&&this._videoBaseElement.parentElement.removeChild(this._videoBaseElement),this._videoScreenElement=null)}_destroyVideoScreen(){!this._videoScreenElement||(this.removeVideoScreen(),this._videoScreenElement=null)}_destroyMediaStream(){this._mediaStream&&this._mediaStream.getTracks().forEach(e=>{e.readyState==="live"&&e.stop()}),this._mediaStream=null}_destroyFaceDetector(){!this._faceDetector||(this._faceDetector.destroy(),this._faceDetector=null)}async _createFaceDetector(){const e=new c({videoElement:this._videoBaseElement,faceUndetectedTimeoutMs:this._faceDetectOptions.faceUndetectedTimeoutMs,modelsUrl:this._faceDetectOptions.modelsUrl,onFaceUndetected:()=>{var t,i;(i=(t=this._options).onFaceUndetected)==null||i.call(t)},onFaceDetected:()=>{var t,i;(i=(t=this._options).onFaceDetected)==null||i.call(t)}});return await e.init(),e}stop(){var t,i;const e=this._isActive;this._destroy(),e&&((i=(t=this._options).onRecordingEnd)==null||i.call(t))}async start(){var e,t,i,a;return u.isAvailableCameraDevice()?(this._mediaStream=await this._createMediaStream(),this._mediaStream&&(this._videoBaseElement=this._createBaseVideoElement(),this._videoBaseElement.srcObject=this._mediaStream,document.body.append(this._videoBaseElement),await this._videoBaseElement.play(),this._faceDetector=await this._createFaceDetector(),this._videoScreenElement=f(),this._videoOptions.elementOrSelector&&this.insertVideoScreen(this._videoOptions.elementOrSelector),this._isActive=!0,(a=(i=this._options).onRecordingStart)==null||a.call(i)),this._mediaStream||(this._isActive=!1,this._destroy()),this._isActive):((t=(e=this._options).onDeviceNotAvailable)==null||t.call(e),!1)}async getScreenshotAsBase64(e={}){var t,i;return(i=(t=await this.getScreenshotAsImg(e))==null?void 0:t.src)!=null?i:null}async getScreenshotAsImg(e={}){var a,n,d,h,l;const t=await this._makeScreenshot();if(!t)return null;const i=m({useAspectRatio:(a=this._screenshotOptions)==null?void 0:a.useAspectRatio,width:(d=(n=this._screenshotOptions)==null?void 0:n.width)!=null?d:this._videoBaseElement.videoWidth,height:(l=(h=this._screenshotOptions)==null?void 0:h.height)!=null?l:this._videoBaseElement.videoHeight},e);return i.useAspectRatio?await S(t,i):await v(t,i)}async getScreenshotAsFile(e){const t=await this.getScreenshotAsBase64(e);if(!t)return null;const i=await g(t);return w(i,{fileName:`${Date.now()}`})}showVideoBase(){this._videoBaseElement.style.cssText=this._videoBaseElement.dataset.cssVisible}hideVideoBase(){this._videoBaseElement.style.cssText=this._videoBaseElement.dataset.cssHidden}insertVideoScreen(e,t={}){if(!this._videoScreenElement||!this._mediaStream)return;this.removeVideoScreen();const{width:i,height:a}=m({width:this._videoOptions.width,height:this._videoOptions.height},t||{});this._videoScreenElement.width=i,this._videoScreenElement.height=a,this._videoScreenElement.srcObject=this._mediaStream,r(this._videoScreenElement,e)}removeVideoScreen(){!this._videoScreenElement||(this._videoScreenElement.srcObject=null,this._videoScreenElement.parentElement&&this._videoScreenElement.parentElement.removeChild(this._videoScreenElement))}}return u});
